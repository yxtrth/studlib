name: 24/7 Backend Keep-Alive Service

on:
  schedule:
    # Run every 10 minutes (GitHub Actions minimum is 5 minutes)
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [main]
    paths: ['keep-alive-24-7.js', '.github/workflows/keep-alive.yml']

jobs:
  keep-backend-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“ Ping Backend Health Endpoint
      run: |
        echo "ğŸš€ Pinging Student Library Backend..."
        echo "ğŸ¯ Target: https://student-library-backend-o116.onrender.com"
        echo "ğŸ• Time: $(date)"
        
        # Ping the health endpoint
        response=$(curl -s -w "\n%{http_code}\n%{time_total}" \
          -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
          -H "Accept: application/json" \
          https://student-library-backend-o116.onrender.com/api/health)
        
        # Extract response parts
        body=$(echo "$response" | head -n -2)
        http_code=$(echo "$response" | tail -n 2 | head -n 1)
        time_total=$(echo "$response" | tail -n 1)
        
        echo "ğŸ“Š Response Code: $http_code"
        echo "â±ï¸ Response Time: ${time_total}s"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Backend is alive and responding!"
          echo "ğŸ“‹ Health Data: $body"
        else
          echo "âŒ Backend health check failed with code: $http_code"
          echo "ğŸ“‹ Response: $body"
          exit 1
        fi

  ping-multiple-endpoints:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: keep-backend-alive
    if: always() # Run even if previous job fails
    
    strategy:
      matrix:
        endpoint: ['/api/health', '/api/auth/login', '/api/auth/register']
      fail-fast: false
    
    steps:
    - name: ğŸ” Test Endpoint ${{ matrix.endpoint }}
      run: |
        echo "ğŸ”— Testing endpoint: ${{ matrix.endpoint }}"
        
        if [ "${{ matrix.endpoint }}" = "/api/health" ]; then
          # GET request for health
          curl -s -f -w "\nHTTP: %{http_code} | Time: %{time_total}s\n" \
            https://student-library-backend-o116.onrender.com${{ matrix.endpoint }}
        else
          # POST request for auth endpoints (expect 400/401 - means server is alive)
          response_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{}' \
            https://student-library-backend-o116.onrender.com${{ matrix.endpoint }})
          
          echo "Response Code: $response_code"
          
          # 400 or 401 means server is alive and responding (validation errors are expected)
          if [ "$response_code" = "400" ] || [ "$response_code" = "401" ] || [ "$response_code" = "200" ]; then
            echo "âœ… Endpoint ${{ matrix.endpoint }} is responding (code: $response_code)"
          else
            echo "âš ï¸ Unexpected response code: $response_code"
          fi
        fi

  log-keep-alive-status:
    runs-on: ubuntu-latest
    needs: [keep-backend-alive, ping-multiple-endpoints]
    if: always()
    
    steps:
    - name: ğŸ“ˆ Log Keep-Alive Activity
      run: |
        echo "ğŸ“Š KEEP-ALIVE SUMMARY"
        echo "====================="
        echo "ğŸ• Timestamp: $(date -u)"
        echo "ğŸ¯ Target: Student Library Backend"
        echo "ğŸŒ URL: https://student-library-backend-o116.onrender.com"
        echo "ğŸ”„ Action: Automated keep-alive ping"
        echo "âš¡ Status: Job completed"
        echo ""
        echo "âœ… This automated ping helps prevent your Render backend from sleeping!"
        echo "ğŸ” Next ping scheduled in ~10 minutes"
            echo "âœ… Health endpoint responded successfully"
          else
            echo "âš ï¸ Health endpoint failed, trying root endpoint..."
            if curl -f -s --max-time 30 "$BACKEND_URL/"; then
              echo "âœ… Root endpoint responded successfully"
            else
              echo "âŒ Both endpoints failed - backend may be down"
              exit 1
            fi
          fi
          
          echo "Ping completed at $(date)"

      - name: Log Status
        run: |
          echo "Keep-alive ping completed"
          echo "Next ping will be in 10 minutes"
